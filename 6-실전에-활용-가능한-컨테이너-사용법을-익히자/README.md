# 실전에 활용 가능한 컨테이너 사용법을 익히자

## 컨테이너와 호스트 간에 파일 복사하기

### 파일 복사

- 서버와 로컬 컴퓨터 간에 파일을 주고받아야 할 때가 있다.

- 파일 복사는 컨테이너 -> 호스트, 호스트 -> 컨테이너로 양방향 모두 가능하다.

- 파일 복사 커맨드

    ```bash
    # 컨테이너로 파일을 복사하는 커맨드
    docker cp $HOST_PATH $CONTAINER_NAME:$CONTAINER_PATH

    # 호스트로 파일을 복사하는 커맨드
    docker cp $CONTAINER_NAME:$CONTAINER_PATH $HOST_PATH
    ```

<br />

## 볼륨 마운트

### 스토리지 마운트의 종류

- 볼륨 마운트

    - 도커 엔진이 관리하는 영역 내에 만들어진 볼륨을 컨테이너에 디스크 형태로 마운트한다.

    - `임시 목적의 사용`이나 `자주 쓰지 않지만 지우면 안 되는 파일`을 두는 목적이다.

        - 이름만으로 관리가 가능하므로 다루기 쉽지만 바인드 마운트에 비해 `직접 조작하기 어려움`

    - 볼륨 마운트는 도커 엔진의 관리하에 있으므로 사용자가 파일 위치를 신경 쓸 필요가 없다.

    - 볼륨 마운트는 도커 컨테이너를 경유하지 않고 직접 볼륨에 접근할 방법이 없다.


- 바인드 마운트

    - 도커 엔진에서 관리하지 않는 영역의 기존 디렉터리를 컨테이너에 마운트

        - `자주 사용하는 파일`을 두는 데 사용한다.

    - 어디라도 파일을 둘 수 있으며, 기존과 동일한 방식으로 파일을 사용할 수 있다.

- 두 가지 마운트 방식의 차이점

    | 항목 | 볼륨 마운트 | 바인드 마운트 |
    |------|-------------|---------------|
    | 스토리지 영역 | 볼륨 | 디렉터리 또는 파일 |
    | 물리적 위치 | 도커 엔진의 관리 영역 | 어디든지 가능 |
    | 마운트 절차 | 볼륨을 생성한 후 마운트 | 기존 파일 또는 폴더를 마운트 |
    | 내용 편집 | 도커 컨테이너를 통해서 | 일반적인 파일과 같이 |
    | 백업 | 절차가 복잡함 | 일반적인 파일과 같이 |

    - 파일을 직접 편집해야 할 일이 많다면 바인드 마운트를 사용하고 그렇지 않다면 볼륨 마운트를 사용

### 스토리지 영역을 마운트하는 커맨드

- 스토리지 영역을 만드는 방법

    - 스토리지를 마운트 하려면 먼저 마운트할 스토리지를 생성해야 한다.

        - 바인드 마운트는 원본이 될 폴더나 파일을 먼저 만든다.

        - 볼륨 마운트는 볼륨 상위 커맨드를를 사용해 먼저 볼륨을 생성한다.

            ```bash
            # create volume
            docker volume create $VOLUME_NAME
            # remove volume
            docker volune rm $VOLUME_NAME
            ```
    
        - 주요 하위 커맨드

            | 커맨드 | 내용 |
            |--------|------|
            | create | 볼륨을 생성 |
            | inspect | 볼륨의 상세 정보를 출력 |
            | ls | 볼륨의 목록을 출력 |
            | prune | 현재 마운트되지 않은 볼륨을 모두 삭제 |
            | rm | 지정한 볼륨을 삭제 |

- 스토리지를 마운트하는 커맨드

    ```bash
    # bind-mount command example
    docker run ... -v $STORAGE_PATH:$CONTAINER_MOUNT_PATH

    # volume-mount command example
    docker run ... -v $VOLUME_NAME:$CONTAINER_MOUNT_PATH
    ```

<br />

## 컨테이너로 이미지 만들기

### commit 커맨드로 컨테이너를 이미지로 변환

- 기존 컨테이너를 복제하거나 이동해야 할 때 활용한다.

    ```bash
    docker commit $CONTAINER_NAME $NEW_IMAGE_NAME
    ```

## Dockerfile 스크립트로 이미지 만들기

- Dockerfile 스크립트에는 토대가 될 이미지나 실행할 명령어 등을 기재한다.

- Dockerfile을 호스트 컴퓨터의 이미지 재료가 들어있는 폴더에 넣는다.

    ```bash
    docker build -t $IMAGE_NAME_TO_CREATE $BASE_FOLDER_PATH
    ```

- 주요 Dockerfile 인스트럭션

    | 인스트럭션 | 내용 |
    |---|---|
    | FROM | 토대가 되는 이미지를 지정 |
    | ADD | 이미지에 파일이나 폴더를 추가 |
    | COPY | 이미지에 파일이나 폴더를 추가 |
    | RUN | 이미지를 빌드할 때 실행할 명령어를 지정 |
    | CMD | 컨테이너를 실행할 때 실행할 명령어를 지정 |
    | ENTRYPOINT | 컨테이너를 실행할 때 실행할 명령어를 강제 지정 |
    | ONBUILD | 이 이미지를 기반으로 다른 이미지를 빌드할 때 실행할 명령어를 지정 |
    | EXPOSE | 이미지가 통신에 사용할 포트를 명시적으로 지정 |
    | VOLUME | 퍼시스턴시 데이터를 저장할 경로를 명시적으로 지정 |
    | ENV | 환경변수를 정의 |
    | WORKDIR | RUN, CMD, ENTRYPOINT, ADD, COPY에 정의된 명령어를 실행하는 작업 디렉터리를 지정 |
    | SHELL | 빌드 시 사용할 셸을 변경 |
    | LABEL | 이름이나 버전, 저작자 정보를 설정 |
    | USER | RUN, CMD, ENTRYPOINT에 정의된 명령어를 실행하는 사용자 또는 그룹을 지정 |
    | ARG | docker build 커맨드를 사용할 때 입력받을 수 있는 인자를 선언 |
    | STOPSIGNAL | docker stop 커맨드를 사용할 때 컨테이너 안에서 실행 중인 프로그램에 전달되는 시그널을 변경 |
    | HEALTHCHECK | 컨테이너 헬스체크 방법을 커스터마이징 |

## 이미지를 옮기는 방법

- 이미지 상태 그대로는 옮기거나 복사할 수 없다.

- 도커 레지스트리를  통하거나 save 커맨드를 사용해 tar 포맷으로 내보내야 한다.

    - tar 파일 생성

        ```bash
        docker save -o $FILE_NAME.tar $IMAGE_NAME
        ```

- 파일을 다시 도커 엔진에 가져오려면 load 커맨드를 사용한다.

<br />

## 컨테이너 개조하기

### 컨테이너를 개조하는 방법

1. 파일 복사와 마운트를 이용한 방법
   
2. 컨테이너에서 직접 리눅스 명령어를 실행하는 방법
   - 소프트웨어를 설치하거나 설정을 변경할 수 있다.

### 컨테이너에서 명령어를 실행하려면 shell이 필요하다

- 컨테이너를 아무 설정 없이 실행하면 bash가 동작하지 않는 상태로 실행된다.
  
- 따라서 bash를 실행해 우리의 명령을 입력받을 수 있는 상태로 만들어야한다.
  
- 컨테이너 속에서 명령어를 실행하는 커맨드인 `docker exec`를 사용한다.
  
    ```bash
    # docker exec (OPTION) $CONTAINER_NAME /bin/bash
    docker exec -it apa000ex23 /bin/bash
    ```

- bash가 실행되면 shell에 입력된 명령은 도커 엔진이 아니라 해당 컨테이너로 전달된다.

  - bash를 통해 컨테이너 내부를 조작하는 동안에는 도커 명령을 사용할 수 없다.

  - 컨테이너 안에서 할 일을 마쳤다면 다시 컨테이너에서 나와야 한다.

### 도커 엔진을 통한 명령과 컨테이너 내부에서 실행하는 명령

- 도커 엔진을 통해야 하는 명령은 `컨테이너 전체에 대한 관리` 작업이다.
  
  - 도커 엔진 자체의 시작 또는 종료, 네트워크, 디스크 설정, 실행 중인 컨테이너 목록 확인 등

- 반면 컨테이너 내부에서 실행하는 명령은 컨테이너 속에 `새로운 소프트웨어 추가`, `소프트웨어의 실행 및 종료`, `설정 변경`, `컨테이너 안과 밖의 파일 복사 및 이동, 삭제` 작업이다.

<br />

## 이미지를 공유하는 방법

### 도커 허브와 도커 레지스트리

- 이미지를 배포하는 장소를 `도커 레지스트리`라고 한다.

- 도커 허브는 도커 제작사에서 운영하는 공식 도커 레지스트리를 말한다.

- `레포지토리`는 레지스트리를 구성하는 단위이다.

    - 레포지토리는 소프트웨어를 단위로 한다.

### 태그와 이미지 업로드

- 이미지에 태그를 부여해 복제하는 커맨드

    ```bash
    # docker tag $ORIGINAL_IMAGE_NAME $REGISTRY_ADDRESS/$REPOSITORY_NAME:$VERSION
    docker tag apa000ex22 zoozoo.coomm/nyapacchi:13
    ```

- 이미지를 업로드하는 커맨드

    ```bash
    # docker push $REGISTRY_ADDRESS/$REPOSITORY_NAME:$VERSION
    docker push zoozoo.coomm/nyapacchi:13
    ```

### 레지스트리를 만드는 방법

- 비공개 레지스트리를 만드는 방법

    ```bash
    docker run -d -p 5000:5000 registry
    ```

- 이미지를 공개적으로 배포하려면 도커 허브를 사용한다.
